#!/bin/bash
# https://www.digitalocean.com/community/tools/nginx?domains.0.server.domain=navysea.lilbillbiscuit.com&domains.0.server.path=%2Fmnt%2Fefs%2Ffs1%2FNavy-Sea-Cadet-Dashboard&domains.0.server.documentRoot=%2FNavyApp&domains.0.https.hstsPreload=true&domains.0.php.php=false&domains.0.reverseProxy.reverseProxy=true&domains.0.reverseProxy.path=%2Fapi%2F&domains.0.reverseProxy.proxyPass=http%3A%2F%2F127.0.0.1%3A8000&domains.0.routing.index=index.html&domains.0.routing.fallbackHtml=true&domains.0.routing.fallbackPhp=false&global.https.ocspCloudflareType=both&global.https.ocspGoogleType=both&global.https.ocspOpenDnsType=both
if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

cd /etc/nginx
echo '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' | base64 --decode | tee /etc/nginx/nginxconfig.io-navysea.lilbillbiscuit.com.tar.gz > /dev/null
tar -czvf nginx_$(date +'%F_%H-%M-%S').tar.gz nginx.conf sites-available/ sites-enabled/ nginxconfig.io/
tar -xzvf nginxconfig.io-navysea.lilbillbiscuit.com.tar.gz | xargs chmod 0644
openssl dhparam -out /etc/nginx/dhparam.pem 2048
mkdir -p /var/www/_letsencrypt
chown www-data /var/www/_letsencrypt
sed -i -r 's/(listen .*443)/\1; #/g; s/(ssl_(certificate|certificate_key|trusted_certificate) )/#;#\1/g; s/(server \{)/\1\n    ssl off;/g' /etc/nginx/sites-available/navysea.lilbillbiscuit.com.conf
sudo nginx -t && sudo systemctl reload nginx
sudo snap install certbot --classic
certbot certonly --webroot -d navysea.lilbillbiscuit.com --email info@navysea.lilbillbiscuit.com -w /var/www/_letsencrypt -n --agree-tos --force-renewal
sed -i -r -z 's/#?; ?#//g; s/(server \{)\n    ssl off;/\1/g' /etc/nginx/sites-available/navysea.lilbillbiscuit.com.conf
sudo nginx -t && sudo systemctl reload nginx
echo -e '#!/bin/bash\nnginx -t && systemctl reload nginx' | sudo tee /etc/letsencrypt/renewal-hooks/post/nginx-reload.sh
sudo chmod a+x /etc/letsencrypt/renewal-hooks/post/nginx-reload.sh
sudo nginx -t && sudo systemctl reload nginx